[force_move]
enable_force_move: True
#####################################################################
## 	                INCLUDES
#####################################################################
[include fluidd.cfg]
[include KAMP_Settings.cfg]
[include mainsail.cfg]
[include timelapse.cfg]
[include Exclude_Object.cfg]
#[include Start_Stop.cfg]
[include Macro.cfg]
[include Speed.cfg]
#[include motor_sync.cfg]
#####################################################################
## 	                GENERAL SETTINGS
#####################################################################
[exclude_object]

[idle_timeout]
timeout: 1800
gcode =
  {% if printer.pause_resume.is_paused %}
    M104 S0
  {% else %}
    TURN_OFF_HEATERS
    #M84
  {% endif %}

[gcode_arcs]
resolution: 0.1

[pause_resume]
recover_velocity: 350

[display_status]

[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode:
    STATUS_ERROR

[firmware_retraction]
retract_length: 0.5
retract_speed: 60
unretract_extra_length: 0.00
unretract_speed: 60
#####################################################################
## 	                 Motherboard configuration
#####################################################################
[mcu]
serial:/tmp/klipper_host_mcu
[mcu]
serial:/dev/serial/by-id/usb-Klipper_stm32f446xx_57003E000A51313133353932-if00
### How to query the USB firmware ID：ls -l /dev/serial/by-id/
#[mcu adxl]
#serial : /dev/serial/by-id/usb-Anchor_Ampon-if00

#####################################################################
##                  Model and acceleration
#####################################################################
[printer]
kinematics: corexy            # Printer type：corexy
max_velocity: 800            # Maximum speed (max. 300)
max_accel: 60000              # Maximum acceleration (max. 4000)
minimum_cruise_ratio: 0.0
#max_accel_to_decel:55000      # Maximum acceleration to deceleration (max. 4000)
max_z_velocity: 15            # Z-axis maximum speed
max_z_accel: 350              # Z-axis maximum acceleration
square_corner_velocity: 15    # Square corner speed

#####################################################################
## 	                ADXL & Input Shaping
#####################################################################
#[adxl345]
#cs_pin: adxl:CS
#[resonance_tester]
#accel_chip: adxl345
#probe_points: 165, 165, 100

[resonance_tester]
accel_chip: beacon
probe_points: 165, 165, 100
accel_per_hz:150

[input_shaper]
shaper_freq_x: 121.8 # center frequency for the X axis filter
shaper_type_x: mzv # filter type for the X axis
shaper_freq_y: 83.6 # center frequency for the Y axis filter
shaper_type_y: mzv # filter type for the Y axis
damping_ratio_x: 0.034 # damping ratio for the X axis
damping_ratio_y: 0.082 # damping ratio for the Y axis

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results             #    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 3                                       #    The number of results to keep in the result_folder. The oldest results will be automatically deleted after each runs.
keep_raw_csv: False                                                #    If True, the raw CSV files will be kept in the result_folder alongside the PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True                                         #    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the  printer.cfg file. If you want to see the macros in the webui, set this to True.
timeout: 600                                                       #    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.


[motors_sync]
axes: x,y
#    Axes on which calibration will be performed.
accel_chip_x:beacon
accel_chip_y:beacon
model: linear
microsteps: 16 #    Maximum microstepping of stepper motor rotor displacement, not worth #    increase the value above 16, do so at your own peril and risk.
model_coeffs: 20000, 0 #    Coefficients above the described model, for calculating microsteps.
max_step_size: 5  #    The maximum number of microsteps that the motor can take move at time,  #    to achieve the planned magnitude.
retry_tolerance: 999999 #    Forced threshold to which a pair of stepper motors should will omit ,#    deviations. After several runs calibration, you will find the limit ,#    to which you can lower this parameter.
retries: 0 #    Maximum number of repetitions to achieve forced motor synchronization,#    deviation threshold.


#####################################################################
## 	                     Beacon
#####################################################################
[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_569222EF5154354D38202020FF0A1D05-if00
x_offset: 0 # update with offset from nozzle on your machine
y_offset: 27 # update with offset from nozzle on your machine
#mesh_main_direction: x
#mesh_runs: 2

#--------------------------------------------------------------------

[safe_z_home]
home_xy_position: 160,160
z_hop: 15

#--------------------------------------------------------------------
[bed_mesh]
algorithm:bicubic
speed:100
mesh_min:40,51
mesh_max:260,245
probe_count:15,15

#--------------------------------------------------------------------
[z_tilt]
z_positions:
  -55, 17
  165, 397
  326, 17
  
points:
  30,30
  165, 220
  300,30
		
horizontal_move_z: 20
speed:200
retries: 10
retry_tolerance: 0.01

#####################################################################
##                  Heater_bed
#####################################################################
[heater_bed]
heater_pin: PA2
sensor_type:  ATC Semitec 104GT-2 #Generic 3950
sensor_pin: PF3
control: pid                 ##heater_bed Temperature PID Calibration Command:  "PID_CALIBRATE HEATER=heater_bed TARGET=100"
pid_Kp:52.410
pid_Ki:1.487
pid_Kd:461.865
min_temp: 0
max_temp: 120
max_power: 1.0

#####################################################################
##	                Temperature Monitoring
#####################################################################
[temperature_sensor Octopus Pro]        
sensor_type: temperature_mcu

[temperature_sensor π4-8gb]
sensor_type: temperature_host

[temperature_sensor Chambers]
sensor_type: EPCOS 100K B57560G104F
sensor_pin:PF6

[temperature_sensor Motors]  #optional for chamber temp
sensor_type: EPCOS 100K B57560G104F
#pullup_resistor: 4700
sensor_pin: PF5
min_temp: 0
max_temp: 99
gcode_id: C: C


#####################################################################
#                   FAN
#####################################################################
#[include CoreConfig/bedfans.cfg]
[fan]
#	Print Cooling Fan - PF8 CPAP
pin: PE5
max_power: 0.8
cycle_time: 0.005
hardware_pwm: false
shutdown_speed: 0
kick_start_time: 0.100 
off_below: 0.1

[heater_fan hotend_fan]
pin: PA8
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[heater_fan Motors]
pin: PD12
max_power: 1.0
kick_start_time: 0.5
#heater: Motors
#heater_temp: 50
#fan_speed: 1.0

[heater_fan Motors2]      
pin: PD13
max_power: 1.0
kick_start_time: 0.5

[fan_generic RSCS]
pin: PD14
max_power: 1
shutdown_speed: 0
kick_start_time: 0.1
off_below: 0.10

#####################################################################
##                  WHITE LED 
#####################################################################

[output_pin LED]
#In FAN8 position if 12 or 5V
#When 24V use a heater pin like Heat4 PF6
pin: PB10
pwm: false
value: 1
shutdown_value:1
### gcode command: SET_PIN PIN=LED value=0 to 1


#####################################################################
##                  Axes and Steppers
#####################################################################

#####################################################################
#   B(X) ---------A(Y)
#   |                |
#   |--------E-------|
#   |                |
#   |                |
#  C(Y1)-(Display)-D(X1)               
#####################################################################
##                   X & Y -axis Configuration
#####################################################################

##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
##########                             Motor  1                                #########
##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########

[stepper_x]
step_pin: PG0                   # Y-axis motor pulse pin setting
dir_pin: !PG1                   # Y-axis motor direction pin setting
enable_pin: !PF15               # Y-axis motor enable pin setting
microsteps: 16                   # Motor microsteps Setting
rotation_distance: 40            # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32), adjusted for PLA with CaliFlower
full_steps_per_rotation:200      # Number of pulses required for a single motor revolution (1.8 degree motor: 200, 0.9 degree motor: 400)
endstop_pin: ^PG10                 # Limit switch PIN pin setting（X-）
position_min: 0                  # X-axis minimum travel - software limit
position_endstop:0               # Mechanical reset point coordinates for X-axis (change to 350 for 350 models)
position_max: 310                # X-axis maximum travel - software limit (change to 350 for 350 models)
homing_speed: 35                 # Reset speed maximum 100
homing_retract_dist: 0          # Setback distance after the first trigger of the reset switch
#homing_positive_dir: True       # Direction of reset (generally no change required)
#--------------------------------------------------------------------

[tmc5160 stepper_x]                # BTT TM5160T Plus
cs_pin: PD11    		           # Y-axis motor pulse pin
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
run_current: 2.2
stealthchop_threshold: 999999
sense_resistor: 0.022

##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
##########                             Motor    3                           #########
##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########

[stepper_x1]
step_pin: PG4                   # Y-axis motor pulse pin setting
dir_pin: !PC1                   # Y-axis motor direction pin setting
enable_pin: !PA0                # Y-axis motor enable pin setting
microsteps: 32                 # Motor microsteps Setting
rotation_distance: 40        # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32), adjusted for PLA with CaliFlower
full_steps_per_rotation:200    # Number of pulses required for a single motor revolution (1.8 degree motor: 200, 0.9 degree motor: 400)
#--------------------------------------------------------------------

[tmc5160 stepper_x1]               # BTT TM5160T Plus
cs_pin: PC7    		               # Y1-axis motor pulse pin
spi_software_sclk_pin: PA5        
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
run_current: 2.2
stealthchop_threshold: 999999
sense_resistor: 0.022

##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
##########                             Motor     0                           #########
##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########

[stepper_y]
step_pin: PF13                   # X-axis motor pulse pin setting
dir_pin: PF12                   # X-axis motor direction pin setting
enable_pin: !PF14                # X-axis motor enable pin setting
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200  
endstop_pin: ^PG9                #make sure to set the correct pin here.
position_endstop: -0
position_min: 0
position_max: 315
homing_speed: 35  
homing_retract_dist: 0
#--------------------------------------------------------------------

[tmc5160 stepper_y]               # BTT TM5160T Plus
cs_pin: PC4
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
run_current: 2.2
stealthchop_threshold: 999999
sense_resistor: 0.022

##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
##########                             Motor   2                           #########
##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########

[stepper_y1]
step_pin: PF11                 # X-axis motor pulse pin setting
dir_pin: !PG3                  # X-axis motor direction pin setting
enable_pin: !PG5              # X-axis motor enable pin setting
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200 
#--------------------------------------------------------------------
[tmc5160 stepper_y1]               # BTT TM5160T Plus
cs_pin: PC6
spi_software_sclk_pin: PA5
spi_software_mosi_pin: PA7
spi_software_miso_pin: PA6
run_current: 2.2
stealthchop_threshold: 999999
sense_resistor: 0.022

##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
##########                            TRIPLE Z CONFIGURATION                  #########
##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
#   |----- Z1 -----|
#   |              |
#   |              |
#   |              |
#   Z0----12864---Z2

##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
##########                             Motor 5            Z0                  #########
##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
[stepper_z2]
step_pin: PC13                       # Z2-axis motor pulse pin
dir_pin: PF0                        # Z2-axis motor direction pin setting
enable_pin: !PF1                     # Z2-axis motor enable pin setting
rotation_distance: 8
full_steps_per_rotation: 200
microsteps: 16
#--------------------------------------------------------------------
[tmc2209 stepper_z2]                 # TMC2209
uart_pin: PE4                        # drive communications port
interpolate: true                     # Enable 256 microstep interpolation
run_current: 0.8                      # Motor running current (mA)
hold_current:0.8                     # Holding current (mA)
sense_resistor: 0.110
stealthchop_threshold: 0

[autotune_tmc stepper_z]
motor: omc-17hs19-2004s1
##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
##########                             Motor 6            Z1                  #########
##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
[stepper_z1]
step_pin: PE2                         # Z1-axis motor pulse pin
dir_pin: PE3                          # Z1-axis motor direction pin setting
enable_pin: !PD4                      # Z1-axis motor enable pin setting
rotation_distance: 8
full_steps_per_rotation: 200
microsteps: 16
#--------------------------------------------------------------------
[tmc2209 stepper_z1]                  # TMC2209
uart_pin: PE1                         # drive communications port
interpolate: true                     # Enable 256 microstep interpolation
run_current: 0.8                      # Motor running current (mA)
hold_current:0.8                     # Holding current (mA)
sense_resistor: 0.110
stealthchop_threshold: 0


[autotune_tmc stepper_z1]
motor: omc-17hs19-2004s1

##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
##########                             Motor 7            Z2                  #########
##########//////////////////////////#############\\\\\\\\\\\\\\\\\\\\\\\\\\\\\#########
[stepper_z]
step_pin: PE6    		                 # Z-axis motor pulse pin
dir_pin: PA14                           # Z-axis motor direction pin setting
enable_pin: !PE0 
rotation_distance: 8
full_steps_per_rotation: 200
microsteps: 16
endstop_pin: probe:z_virtual_endstop
homing_positive_dir:false
position_min: -15
position_max: 320
homing_speed: 5 #15
second_homing_speed: 2
homing_retract_dist: 0
#--------------------------------------------------------------------
[tmc2209 stepper_z]
uart_pin: PD3
interpolate: true                     # Enable 256 microstep interpolation
run_current: 0.8                      # Motor running current (mA)
hold_current:0.8                     # Holding current (mA)
sense_resistor: 0.110
stealthchop_threshold: 0

[autotune_tmc stepper_z2]
motor: omc-17hs19-2004s1


#####################################################################
##                +  Extruder motor  MOTOR 4
#####################################################################
[extruder]
### Vz-HextrudORT
step_pin: PF9    
dir_pin: !PF10   
enable_pin: !PG2
microsteps: 16
#VZHextrudort LDO 20mm
rotation_distance: 26.85
Gear_ratio: 60:10
nozzle_diameter: 0.5
filament_diameter: 1.750
heater_pin: PA3
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF4
control: pid  ##Calibration command："PID_CALIBRATE HEATER=extruder TARGET=245"
pid_Kp: 24.382 
pid_Ki: 2.852
pid_Kd: 52.116
min_temp: 0
max_temp: 400
full_steps_per_rotation: 200
max_extrude_only_distance: 1000.0
max_extrude_cross_section: 500
max_extrude_only_velocity: 200
max_extrude_only_accel: 10000
min_extrude_temp: 190
## PA Calibration Values
pressure_advance: 0.02                 # Propulsion pressure - try to keep pressure below 1.0
pressure_advance_smooth_time: 0.03     # Smooth advance time - default value is 0.040

[tmc2209 extruder]
uart_pin: PF2
interpolate: false
run_current: 0.7
sense_resistor: 0.110

[autotune_tmc extruder]
motor: ldo-36sth20-1004ahg

[autotune_tmc stepper_x]
motor: ldo-42sth48-2804ah
[autotune_tmc stepper_x1]
motor: ldo-42sth48-2804ah
[autotune_tmc stepper_y]
motor: ldo-42sth48-2804ah
[autotune_tmc stepper_y1]
motor: ldo-42sth48-2804ah

#####################################################################
#	                GCODE MACROS 
#####################################################################


#--------------------------------------------------------------------
#                    Print_start macro
#--------------------------------------------------------------------

[gcode_macro PRINT_START]
gcode:
  # This part fetches data from your slicer. Such as bed temp, extruder temp, chamber temp and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set target_chamber = params.CHAMBER|default("40")|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

  # Homes the printer, sets absolute positioning and updates the Stealthburner leds.
  STATUS_HOMING         # Sets SB-leds to homing-mode
  G28                   # Full home (XYZ)
  G90                   # Absolut position

  ##  Uncomment for bed mesh (1 of 2)
  BED_MESH_CLEAR       # Clears old saved bed mesh (if any)

  # Checks if the bed temp is higher than 90c - if so then trigger a heatsoak.
  {% if params.BED|int > 90 %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Displays info
    STATUS_HEATING                                      # Sets SB-leds to heating-mode
    M106 S255                                           # Turns on the PT-fan

    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Goes to center of the bed
    M190 S{target_bed}                                  # Sets the target temp for the bed
    SET_DISPLAY_TEXT MSG="Heatsoak: {target_chamber}c"  # Displays info
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}   # Waits for chamber to reach desired temp

  # If the bed temp is not over 90c, then it skips the heatsoak and just heats up to set temp with a 5min soak
  {% else %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Displays info
    STATUS_HEATING                                      # Sets SB-leds to heating-mode
    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Goes to center of the bed
    M190 S{target_bed}                                  # Sets the target temp for the bed
    SET_DISPLAY_TEXT MSG="Soak for 1min"                # Displays info
    G4 P60000                                          # Waits 1 min for the bedtemp to stabilize
  {% endif %}

  # Heating nozzle to 150 degrees. This helps with getting a correct Z-home
  SET_DISPLAY_TEXT MSG="Hotend: 200c"          # Displays info
  M109 S200                                    # Heats the nozzle to 200c

  ##  Uncomment for V2 (Quad gantry level AKA QGL)
  SET_DISPLAY_TEXT MSG="Yatak Hizalanıyor"      # Displays info
  STATUS_LEVELING                 # Sets SB-leds to leveling-mode
  z_tilt               # Levels the buildplate via QGL
  G28 Z                           # Homes Z again after QGL

  ##  Uncomment for bed mesh (2 of 2)
  SET_DISPLAY_TEXT MSG="Bed mesh"    # Displays info
  STATUS_MESHING                     # Sets SB-leds to bed mesh-mode
  bed_mesh_calibrate                 # Starts bed mesh

  # Heats up the nozzle up to target via data from slicer
  SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"             # Displays info
  STATUS_HEATING                                                # Sets SB-leds to heating-mode
  G1 X{x_wait} Y{y_wait} Z15 F9000                              # Goes to center of the bed
  M107                                                          # Turns off partcooling fan
  M109 S{target_extruder}                                       # Heats the nozzle to printing temp

  # Gets ready to print by doing a purge line and updating the SB-leds
  SET_DISPLAY_TEXT MSG="Basıyor Zalımın Çocuğu"          # Displays info
  STATUS_PRINTING                                  # Sets SB-leds to printing-mode
  G0 X{x_wait - 50} Y4 F10000                      # Moves to starting point
  G0 Z0.4                                          # Raises Z to 0.4
  G91                                              # Incremental positioning 
  G1 X100 E20 F1000                                # Purge line
  G90                                              # Absolut position

#--------------------------------------------------------------------
#                    Print_END macro
#--------------------------------------------------------------------

[gcode_macro PRINT_END]            # Set PRINT_END as the macro executed at the end of printing, customize the action after printing is completed.
gcode:
    #   Get Boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}
    
    #   Check end position to determine safe directions to move
    {% if printer.toolhead.position.x < (max_x - 20) %}
        {% set x_safe = 20.0 %}
    {% else %}
        {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
        {% set y_safe = 20.0 %}
    {% else %}
        {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 2) %}
        {% set z_safe = 2.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}
 
    M400
    G92 E0
    G1 E-10.0 F3600
    G91
    G0 Z{z_safe} F3600
    G0 X{x_safe} Y{y_safe} F20000
    M104 S0
    M140 S0
    M106 S0
    G90
    G0 X{max_x / 2} Y{max_y} F3600
    BED_MESH_CLEAR

#--------------------------------------------------------------------
#                    Print_Cancel macro
#--------------------------------------------------------------------

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
variable_park: True
gcode:
  ## Move head and retract only if not already in the pause state and park set to true
  {% if printer.pause_resume.is_paused|lower == 'false' and park|lower == 'true'%}
    _TOOLHEAD_PARK_PAUSE_CANCEL
  {% endif %}
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE

[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Helper: park toolhead used in PAUSE and CANCEL_PRINT
variable_extrude: 1.0
gcode:
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  {% set z_park_delta = 2.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - z_park_delta) %}
    {% set z_safe = z_park_delta %}
  {% else %}
    {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    M83
    G1 E-{extrude} F2100
    {% if printer.gcode_move.absolute_extrude |lower == 'true' %} M82 {% endif %}
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G91
    G1 Z{z_safe} F900
    G90
    G1 X{x_park} Y{y_park} F6000
    {% if printer.gcode_move.absolute_coordinates|lower == 'false' %} G91 {% endif %}
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %}

#--------------------------------------------------------------------
#                    Print_Pause macro
#--------------------------------------------------------------------

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
# change this if you need more or less extrusion
variable_extrude: 1.0
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
  {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% if act_z < (max_z - 2.0) %}
      {% set z_safe = 2.0 %}
  {% else %}
      {% set z_safe = max_z - act_z %}
  {% endif %}
  ##### end of definitions #####
  PAUSE_BASE
  G91
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G1 E-{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}
  {% if "xyz" in printer.toolhead.homed_axes %}
    G1 Z{z_safe} F900
    G90
    G1 X{x_park} Y{y_park} F6000
  {% else %}
    {action_respond_info("Printer not homed")}
  {% endif %} 
  
#--------------------------------------------------------------------
#                    Print_Resume macro
#--------------------------------------------------------------------

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro PAUSE"].extrude|float %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F2100
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}  
  RESUME_BASE {get_params}

#--------------------------------------------------------------------
#                    Purge line
#--------------------------------------------------------------------

  [gcode_macro _PURGE_LINE]
gcode:
    {% if "z" not in printer.toolhead.homed_axes %}
      G28                             ;Only G28 Home if needed
    {% endif %}
    M117 Purging...
    G0 X50 Y0 Z0.2 F9000         ; Move to start position
    G92 E0                        ; Reset Extruder
    G1 E10 F600                   ; Extrude a little
    G1 X108 E20 F1000              ; Draw line
    G92 E0                        ; Reset Extruder
    G91                           ; relative positioning
    G0 Z10 F1000                  ; Raise nozzle
    G90

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.5582494741861297,
#*# 	1.9288093418055368,
#*# 	0.821223068203411,
#*# 	0.3470435723863061,
#*# 	0.23441022379148155,
#*# 	0.13269972572120323,
#*# 	-0.28089006956936247,
#*# 	-0.17011818974608817,
#*# 	0.2666315912696853,
#*# 	0.16388883915507813
#*# model_domain = 1.8682100226415576e-07,1.9416069643272427e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 29.774911
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.061824, -0.060462, -0.055815, -0.042249, -0.035880, -0.025731, -0.029480, -0.023758, -0.019937, -0.009701, -0.016526, -0.025707, -0.037612, -0.034538, -0.044124
#*# 	  -0.066222, -0.059173, -0.054519, -0.042301, -0.036041, -0.029333, -0.031068, -0.024754, -0.021729, -0.008342, -0.016774, -0.023002, -0.035109, -0.029978, -0.040810
#*# 	  -0.058038, -0.048116, -0.047078, -0.037994, -0.032193, -0.021865, -0.021547, -0.015710, -0.009961, 0.001960, -0.005879, -0.011822, -0.024979, -0.020849, -0.030808
#*# 	  -0.044272, -0.037621, -0.037194, -0.027929, -0.020244, -0.005779, -0.006797, 0.000197, 0.006402, 0.015454, 0.011258, 0.004620, -0.007496, -0.003650, -0.013642
#*# 	  -0.043884, -0.036236, -0.036815, -0.026715, -0.015164, -0.003799, -0.000304, 0.006127, 0.009567, 0.019622, 0.014731, 0.009791, -0.002417, 0.000155, -0.007936
#*# 	  -0.041502, -0.031490, -0.031221, -0.019939, -0.009097, 0.002540, 0.004228, 0.009988, 0.012554, 0.020309, 0.014769, 0.011264, -0.002529, 0.000160, -0.006905
#*# 	  -0.037933, -0.029733, -0.026608, -0.014068, -0.004247, 0.006027, 0.004039, 0.009813, 0.015760, 0.020892, 0.014649, 0.007176, -0.005279, -0.000266, -0.007461
#*# 	  -0.037164, -0.028398, -0.026685, -0.013625, -0.001146, 0.005018, 0.004741, 0.013474, 0.019717, 0.028798, 0.016657, 0.008719, -0.003353, 0.000916, -0.006710
#*# 	  -0.032762, -0.024626, -0.022915, -0.010066, -0.001642, 0.005971, 0.010492, 0.018041, 0.021635, 0.036427, 0.033320, 0.016872, -0.001578, 0.000835, -0.009639
#*# 	  -0.036881, -0.030812, -0.026678, -0.015231, -0.007239, 0.001103, 0.005316, 0.011696, 0.016089, 0.024281, 0.026111, 0.012949, -0.006503, -0.008098, -0.018596
#*# 	  -0.047761, -0.039325, -0.036657, -0.025416, -0.017827, -0.009772, -0.006500, 0.000445, 0.002618, 0.007539, 0.003728, -0.000665, -0.015585, -0.023643, -0.030141
#*# 	  -0.060610, -0.055590, -0.052210, -0.041196, -0.033426, -0.022537, -0.018442, -0.012235, -0.012344, -0.009335, -0.010371, -0.014597, -0.030686, -0.038438, -0.043462
#*# 	  -0.068900, -0.067728, -0.065159, -0.054162, -0.045083, -0.033838, -0.029595, -0.022058, -0.023013, -0.018654, -0.019058, -0.022913, -0.038812, -0.046401, -0.052948
#*# 	  -0.076571, -0.075498, -0.074851, -0.061872, -0.050475, -0.042036, -0.038712, -0.033174, -0.031511, -0.028740, -0.029826, -0.032308, -0.046989, -0.056407, -0.062749
#*# 	  -0.081093, -0.076918, -0.075590, -0.062621, -0.050516, -0.040151, -0.040112, -0.035510, -0.032574, -0.032415, -0.033959, -0.037788, -0.053601, -0.061786, -0.066537
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 260.0
#*# min_y = 51.0
#*# max_y = 245.0
